<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Buscar Anime - Jikan API</title>
    <style>
        /* Estilização básica para a página */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f4f4f9;
        }

        h1 {
            color: #333;
        }

        input[type="text"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #resultado {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        /* Estilo para as "tags" de gênero, tema, etc. */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0;
            margin: 10px 0;
        }

        .tag {
            background-color: #e9ecef;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #495057;
            border: none; /* Garante que botões pareçam tags */
            cursor: pointer; /* Adiciona cursor para botões de relação */
        }
        .tag:hover {
            background-color: #d3d9df;
        }
    </style>
</head>
<body>

    <h1>Buscar Anime</h1>
    <input type="text" id="animeInput" placeholder="Digite o nome do anime">
    <button onclick="buscarAnime()">Buscar</button>

    <div id="resultado"></div>

    <script>
        const resultadoDiv = document.getElementById('resultado');

        // Função auxiliar para formatar listas simples em tags
        function formatarLista(lista) {
            if (!lista || lista.length === 0) return '<span class="tag">N/A</span>';
            return lista.map(item => `<span class="tag">${item.name}</span>`).join(' ');
        }

        // Função para tradução básica do status da API
        function traduzirStatus(statusApi) {
            switch (statusApi) {
                case 'Finished Airing': return 'Já acabou';
                case 'Currently Airing': return 'Está lançando';
                case 'Not yet aired': return 'Ainda não foi ao ar';
                default: return statusApi;
            }
        }

        // Função avançada que determina o status real do anime
        function determinarStatusInteligente(anime) {
            const hoje = new Date();
            const temSequencia = anime.relations?.some(rel => rel.relation === 'Sequel');
            if (anime.status === 'Finished Airing' && temSequencia) {
                return 'Finalizado (continuação anunciada)';
            }
            const dataTermino = anime.aired?.to ? new Date(anime.aired.to) : null;
            if (dataTermino && dataTermino < hoje) return 'Já acabou';
            if (anime.status === 'Finished Airing' && dataTermino === null) return 'Pausado / Em hiato';
            return traduzirStatus(anime.status);
        }
        
        // Função que cria os botões clicáveis para animes relacionados
        function formatarRelacoes(relacoes) {
            if (!relacoes || relacoes.length === 0) return '<span class="tag">Nenhuma conhecida</span>';
            return relacoes.map(rel => {
                const relatedEntry = rel.entry[0] || rel.entry[1];
                if (!relatedEntry || !relatedEntry.mal_id) return '';
                // O onclick chama a nossa função principal com o ID da sequência/prequela etc.
                return `<button class="tag" onclick="exibirDadosAnime(${relatedEntry.mal_id})">${rel.relation}: ${relatedEntry.name}</button>`;
            }).join(' ');
        }

        // Função principal que busca por ID e exibe os dados na tela
        async function exibirDadosAnime(animeId) {
            const url = `https://api.jikan.moe/v4/anime/${animeId}`;
            resultadoDiv.innerHTML = '<p>Buscando...</p>';
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Erro na API: ${res.statusText}`);
                const data = await res.json();
                if (!data.data) {
                    resultadoDiv.innerHTML = `<p>Não foi possível carregar os dados para o anime ID: ${animeId}.</p>`;
                    return;
                }
                const anime = data.data;
                const statusInteligente = determinarStatusInteligente(anime);
                const trailerLink = anime.trailer?.youtube_id ? `<a href="https://www.youtube.com/watch?v=${anime.trailer.youtube_id}" target="_blank">Assistir Trailer</a>` : "Nenhum trailer disponível";

                resultadoDiv.innerHTML = `
                    <h2>${anime.title_synonyms.includes("Japanese") ? anime.title_japanese : anime.title} (${anime.year || 'N/A'})</h2>
                    <img src="${anime.images?.jpg?.large_image_url || ''}" alt="Capa de ${anime.title}" width="200" style="float: left; margin-right: 20px; border-radius: 8px;">
                    <p><strong>Tipo:</strong> ${anime.type || "N/A"} | <strong>Fonte:</strong> ${anime.source || "N/A"} | <strong>Status:</strong> ${statusInteligente}</p>
                    <p><strong>Episódios:</strong> ${anime.episodes || "N/A"}</p>
                    <p><strong>Score:</strong> ${anime.score ? anime.score.toFixed(2) : "N/A"}</p>
                    <p style="clear: both;"><strong>Gêneros:</strong></p>
                    <div class="tags">${formatarLista(anime.genres)}</div>
                    <p><strong>Temas:</strong></p>
                    <div class="tags">${formatarLista(anime.themes)}</div>
                    <p><strong>Estúdios:</strong></p>
                    <div class="tags">${formatarLista(anime.studios)}</div>
                    <p><strong>Relações:</strong></p>
                    <div class="tags">${formatarRelacoes(anime.relations)}</div>
                    <p><strong>Sinopse:</strong></p> 
                    <p>${anime.synopsis ? anime.synopsis.replace(/\n/g, '<br>') : "Sinopse não disponível."}</p>
                    <p><strong>Trailer:</strong> ${trailerLink}</p>
                `;
            } catch (error) {
                resultadoDiv.innerHTML = `<p>Ocorreu um erro ao buscar o anime.</p>`;
                console.error('Erro ao buscar por ID:', error);
            }
        }

        // Função inicial que busca por nome e chama a função principal
        async function buscarAnime() {
            const nomeAnime = document.getElementById('animeInput').value;
            if (!nomeAnime) {
                resultadoDiv.innerHTML = '<p>Por favor, digite o nome de um anime.</p>';
                return;
            }
            const url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(nomeAnime)}&limit=1`;
            resultadoDiv.innerHTML = '<p>Buscando...</p>';
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Erro na API: ${res.statusText}`);
                const data = await res.json();
                if (!data.data || data.data.length === 0) {
                    resultadoDiv.innerHTML = `<p>Nenhum resultado encontrado para "${nomeAnime}".</p>`;
                    return;
                }
                const animeId = data.data[0].mal_id;
                exibirDadosAnime(animeId);
            } catch (error) {
                resultadoDiv.innerHTML = `<p>Ocorreu um erro ao buscar.</p>`;
                console.error('Erro na busca por nome:', error);
            }
        }
    </script>

</body>
</html>